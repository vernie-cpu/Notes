## MYSQL入门

### MYSQL 的分支、变种及替代

- Drizzle：从mysql fork 出来的，但是和mysql很不兼容。主要是用来提高数据库的可用性问题。
- MariaDB：包含了mysql所有功能，并提供更多的扩展。
- Percona Server：向后兼容mysql，提供对数据库内部执行逻辑对外开放和性能优化。
- Postgre SQL(PG)：稳定性极强，面对高并发、灾难备份等。
- SQLite：物联网数据库首选，无需启动进程就可运行。



### MYSQL 体系架构

#### 架构组件

> 在进入mysql内部之前，要依赖各种API接口，即客户端来发起链接。

- 连接池：创建链接、控制连接数、身份认证、权限校验、链接缓存。连接池减少链接创建、销毁的开销，提升mysql性能。
- 管理工具和服务：SQL复制、集群管理等。
- SQL接口：接收客户端的SQL语句。
- Parser：解析SQL语句，检查SQL语句的语法正确性，不正确就直接返回了。
- Optimizer：优化解析出来的SQL执行语句。
- Caches&Buffer：5.7 以前版本，执行SQL时会默认开启查询缓存。
- 插件式引擎：mysql为操作引擎提供了统一接口，用户可根据需要使用不同的操作引擎，只要实现mysql的接口即可。当前MYSQL默认使用的引擎是InnoDB。
- 文件与日志系统：操作引擎的读写对象，占用磁盘空间。



#### 架构分层

- **连接层**    组件包含 连接池，主要作用是 创建新的连接线程、以及缓存已经创建好的线程；同时完成对客户端的身份认证、权限认证。

  ``` shell
  # 查看数据库配置的最大连接数
  mysql> show variables like '%max_connections%';
  +-----------------+-------+
  | Variable_name   | Value |
  +-----------------+-------+
  | max_connections | 151   |
  +-----------------+-------+
  1 row in set (0.01 sec)
  
  # 通常max_connections在小于2*CPU核数时，执行效率是最高的。
  ```

- **Server 层**	组件包含 SQL接口、Parser、Optimizer、Caches&Buffer。主要就是 接收客户端的SQL请求，完成对SQL的解析、语法检查、优化后，交给操作引擎执行语句。mysql 5.7 之后，不再默认开启缓存查询，因为 mysql 缓存采用hash映射保存，需要逐个字符检查是否命中，加之SQL语句千变万化，命中的概率更小，故在mysql 8.0 之后完全弃用了。

  ``` shell
  # 查看数据库是否开启缓存。查询版本为 5.7，缓存大小一般是 1M
  mysql> show variables like '%query_cache_type%';
  +------------------+-------+
  | Variable_name    | Value |
  +------------------+-------+
  | query_cache_type | OFF   |
  +------------------+-------+
  1 row in set (0.00 sec)
  ```

- **存储引擎层**	组件包含 引擎。这里是真正执行sql语句，读写磁盘的地方。引擎实现了对系统文件系统的具体操作。

  - InnoDB：当前默认引擎，最开始是三方引擎。擅长处理大量的短事物。
  - MyISAM：5.1 版本之前的默认引擎。
  - Archive：压缩数据保存，占用空间很小，只支持插入和查询操作。但查询时需要解压，比较费时。主要应用在日志采集方面。
  - Blackhole：不做数据保存落盘，只记录操作日志。主要用于mysql复制，不拷贝磁盘数据，而是由从库自己执行语句落盘。
  - CSV：针对csv格式文件。主要用于数据处理方面。
  - Federated：实现本地数据库 访问 远程数据库中的数据。
  - Memory：数据放到内存中，读写很快。但是没有持久化。
  - NDB集群引擎：用于mysql集群。

  ``` shell
  mysql> show engines; # 查看数据库支持哪些引擎
  +--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
  | Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
  +--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
  | MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
  | MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
  | CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
  | BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |
  | MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
  | PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
  | ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |
  | InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
  | FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |
  +--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
  
  mysql> show variables like '%storage_engine%'; # 查看默认使用的引擎
  +----------------------------------+--------+
  | Variable_name                    | Value  |
  +----------------------------------+--------+
  | default_storage_engine           | InnoDB |
  | default_tmp_storage_engine       | InnoDB |
  | disabled_storage_engines         |        |
  | internal_tmp_disk_storage_engine | InnoDB |
  +----------------------------------+--------+
  
  mysql> set default_storage_engine=MyISAM; #修改默认存储引擎
  Query OK, 0 rows affected (0.01 sec)
  
  mysql> show variables like '%storage_engine%';
  +----------------------------------+--------+
  | Variable_name                    | Value  |
  +----------------------------------+--------+
  | default_storage_engine           | MyISAM |
  | default_tmp_storage_engine       | InnoDB |
  | disabled_storage_engines         |        |
  | internal_tmp_disk_storage_engine | InnoDB |
  +----------------------------------+--------+
  4 rows in set (0.00 sec)
  ```
  
  

### 目录结构

- bin 目录：存放可执行文件

  - mysqld：mysqld服务器程序，用来启动mysql

  - mysqld_safe: 一个执行脚本，内部调用mysqld，同时启动一个守护进程，当主进程mysql服务挂掉后，守护进程会再起动一个，同时mysqld_safe还会主动收集错误日志。

    ``` shell
    ./bin/mysql_safe --defaults-file=/var/local/my.conf --user=mysql &
    # 指定服务启动的配置文件、启动的用户信息，后台运行
    # 变量参数分类：
    # 按性质：
    # 	静态：在服务启动时指定，服务运行过程中不允许再做修改
    #   动态：与静态相反
    # 按作用域：
    #		全局：作用于所有实例的变量。修改时加上关键子字 global。 例如：set global rootdir="/db/dir"
    # 	局部：在当前实例生效的。修改变量时，直接 set 就可以
    ```

  - mysql.server: 默认不存放在bin目录，默认放在support_files文件夹。它内部调用mysqld_safe，用于启动和关闭mysql服务

    ``` shell
    mysql.server start/stop
    ```

  - mysql_multi: 用于在同一台服务器启动多个mysql实例

  - mysqladmin：客户端程序，检查mysql服务配置等

  - mysqldump：客户端程序，实现mysql逻辑备份

- 数据目录：存放mysql数据文件，数据目录路径在服务启动时，由conf 配置文件制定的

  ``` shell
  mysql> show variables like '%datadir%';  # 查看数据目录，这是个静态变量，只能通过配置文件修改重启服务生效
  +---------------+-----------------+
  | Variable_name | Value           |
  +---------------+-----------------+
  | datadir       | /var/lib/mysql/ |
  +---------------+-----------------+
  ```

  存放数据：

  - 库在文件系统中的表示。我们每创建一个database就会在datadir目录下新增一个以database命名的文件夹。

  - 表在文件系统中的表示。在database的文件夹中，就存放了每张表的数据文件。其中 表名.frm 记录表的结构（列名、数据类型、外键信息等）。表名.ibd 存放表的数据和索引。MyISAM引擎创建的表用 表名.MYD 存储数据；表名.MYI 存储索引。

  - 数据存放位置。在mysql 5.5.8 之后，将会为每张表都创建一个独立的空间（表空间）来保存表相关数据。

  - 日志文件。包括 错误日志、慢查询日志（默认是不开启的）、查询日志（默认是不开启的，比较影响性能）。

    ``` shell
    mysql> show variables like '%log_error%';  # 此时的错误日志并没有输出到日志文件
    +---------------------+--------------+
    | Variable_name       | Value        |
    +---------------------+--------------+
    | binlog_error_action | ABORT_SERVER |
    | log_error           | stderr       |
    | log_error_verbosity | 3            |
    +---------------------+--------------+
    3 rows in set (0.00 sec)
    ```

  - 二进制文件（bin log）:记录所有对mysql数据修改的操作。当进行数据库的迁移时，就是读取的 bin log日志，在新库中执行相同的数据修改操作。

- 数据库事物

  > 事物是数据库管理系统(DBMS)执行过程中的一个逻辑单位（不可再进行分割），由一个有限的数据库操作序列构成（多个DML语句，select语句不包含事物），要不全部成功，要不全部不成功。

  四大特性：

  - 原子性（Atomicity）
  - 一致性（Consistency）
  - 持久性（Durability）
  - 隔离型（Isolation）









## 常见问题解答

### 一、如何排查数据库慢的原因

### 二、 如何优化慢查询语句

